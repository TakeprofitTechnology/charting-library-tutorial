name: Auto Merge Version PR

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  check_run:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        token: ${{ secrets.AUTO_MERGE_TOKEN }}

    - name: 'Get Changed Files'
      id: files
      uses: jitterbit/get-changed-files@v1
      continue-on-error: true

    - name: 'Check PR title'
      uses: actions-ecosystem/action-regex-match@v2
      id: regex-match
      with:
        text: ${{ github.event.pull_request.title }}
        regex: '[\s\S]+v\s*\d+\.\d+(\.\d+(\.\d+(\.\d+)?)?)?'

    - name: Check if only specified files are modified
      id: check-files
      run: |
        FILES="${{ steps.files.outputs.all }}"
        for FILE in $FILES; do
          if [[ "$FILE" != *".csproj" && "$FILE" != *"Const.h" && "$FILE" != *"version.h" ]]; then
            echo "Detected changes in files outside the specified patterns."
            echo "::set-output name=only_specified::false"
            exit 0
          fi
        done
        echo "::set-output name=only_specified::true"
      
    - name: Merge branch into master
      if: steps.regex-match.outputs.match != '' && steps.check-files.outputs.only_specified == 'true'
      run: |
        git config --global user.email "sysadmin@takeprofittech.com"
        git config --global user.name "takeprofittechbot"
        git remote update
        git fetch 
        git checkout --track origin/${{ github.event.pull_request.head.ref }}
        git checkout master
        echo "After checkout, before merge"
        git merge ${{ github.event.pull_request.head.ref }} --no-ff -m "Merge dev-version into master"
        echo "After merge, before push"
        git push origin ${{ github.event.pull_request.base.ref }} --force
        echo "After push, before deletion"
        git push origin --delete ${{ github.event.pull_request.head.ref }} --force
        echo "After deletion, done"